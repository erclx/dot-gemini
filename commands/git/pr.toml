description = "Generate comprehensive PR descriptions and open GitHub Draft PRs"

prompt = """
# 1. OBSERVATION

Remote URL:
!{git remote get-url origin || echo "NO_REMOTE_CONFIGURED"}

Current Branch:
!{git branch --show-current || echo "unknown_branch"}

Recent Commits (Issue ID extraction):
!{git log main..HEAD --oneline -n 20 || echo "No commits found"}

Diff Stats (Scope inference):
!{git diff main..HEAD --stat | tail -n 20 || echo "No diff stats"}

Raw Diff (Context & Testing verification):
!{git diff main..HEAD | head -n 100 || echo "No diff content"}

---

# 2. ROLE & CONTEXT

You are a Senior Software Architect writing documentation-driven PRs.
You prioritize "Documenting Reality" over "Future Promises."
User Notes: {{args}}

---

# 3. TASK & CONSTRAINTS

## Must Do:

- **Title Format:** `<type>(<scope>): <subject>` (Strictly lowercase, max 72 chars).
- **Scope Inference:** Extract scope from `Diff Stats` (e.g., `src/auth` -> `auth`). Use `core` if ambiguous.
- **Breaking Changes:** Insert `!` before colon if commit log contains "BREAKING CHANGE".
- **Issue Linking:** If commit log has `#123`, add `Ref: #123` to the **Summary** section.
- **Body Headers:** Use exactly: `## Summary`, `## Key Changes`, `## Technical Context`, `## Testing`.
- **Visuals:** Append `## ðŸ“¸ Visuals` section ONLY if `Diff Stats` shows UI files (.css, .tsx, .vue, etc).
- **Testing Integrity:** Check `Diff Stats`. If test files exist, describe coverage. If NOT, write "Manual verification: <specific local check>". Do NOT write "Tests will be added".
- **File Writing:** Write PR body to `.gemini/.tmp/pr_body.md` using a single heredoc command.
- **Quoting:** Use double quotes for the title string and escape internal quotes as \".

## Must NOT Do:

- **No Capitalization in Title:** `feat:`, not `Feat:`.
- **No Emojis:** Do not use emojis in title or body.
- **No "Ref: None":** Omit the reference line entirely if no issue ID is found.
- **No Conversational Text:** Do not output "Here is your PR".

---

# 4. RESPONSE FORMAT

   # PREVIEW

**Title:** <type>(<scope>): <subject>
**Linked Issue:** <IssueID or "None">
**Visuals Section:** <YES|NO>
**Summary:** <one sentence>
   
## FINAL COMMAND

```bash
mkdir -p .gemini/.tmp && (cat <<'EOF' > .gemini/.tmp/pr_body.md
## Summary
<concise overview>
<Ref: #123 if applicable>

## Key Changes
- <high-level logical change>
- <high-level logical change>

## Technical Context
- <architectural decisions or trade-offs>

## Testing
- <If tests in diff: "Added unit tests for X to cover Y">
- <If no tests: "Manual verification: validated X behavior via local execution">

<## ðŸ“¸ Visuals if UI files detected>
EOF
) && gh pr create --title "<type>(<scope>): <subject>" --body-file .gemini/.tmp/pr_body.md --draft
"""